{
    "app-id": "org.mozilla.Thunderbird",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "19.08",
    "sdk": "org.freedesktop.Sdk",
    "sdk-extensions": [
        "org.freedesktop.Sdk.Extension.rust-stable",
        "org.freedesktop.Sdk.Extension.node10"
    ],
    "command": "thunderbird",
    "rename-icon": "thunderbird",
    "finish-args": [
        /* X11 + XShm access */
        "--share=ipc", "--socket=x11",
        /* Wayland access */
        "--socket=wayland",
        /* OpenGL access */
        "--device=dri",
        /* Needs to talk to the network: */
        "--share=network",
        /* Play sounds */
        "--socket=pulseaudio",
        /* Make thunderbird configuration persistent */
        "--persist=.thunderbird",
        /* Access to Public directory (read-only, to upload attachments) */
        "--filesystem=xdg-public-share:ro",
        /* Access to Downloads (to download attachments) */
        "--filesystem=xdg-download:rw",
        /* Needed for accessibility */
        "--talk-name=org.a11y.*",
        /* Make notifications work */
        "--talk-name=org.freedesktop.Notifications",
        /* Smartcard access - Requires flatpak >= 1.3.2 */
        "--socket=pcsc",
        /* Older versions will fail with above permission */
        "--require-version=0.10.3"
    ],
    "cleanup": [
        "/include",
        "/lib/pkgconfig",
        "/lib/girepository-1.0",
        "/share/pkgconfig",
        "/share/aclocal",
        "/share/gtk-doc",
        "/share/doc",
        "/share/info",
        "/share/gir-1.0",
        "/share/man",
        "/man",
        "*.la", "*.a"
    ],
    "modules": [
        "shared-modules/gtk2/gtk2.json",
        "shared-modules/dbus-glib/dbus-glib-0.110.json",
            {
            "name": "gcr",
            "config-opts": [
                "--disable-static",
                "--disable-update-mime",
                "--disable-schemas-compile",
                "--enable-valgrind=no"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://download.gnome.org/sources/gcr/3.34/gcr-3.34.0.tar.xz",
                    "sha256": "29df50974a90987af694c0fb8926a6b366e68cacd8abd813817cfe1eb5d54524"
                }
            ]
        },
            {
            "name": "pinentry",
            "config-opts": [
                "--enable-pinentry-gnome3",
                "--disable-ncurses",
                "--disable-fallback-curses",
                "--disable-pinentry-curses",
                "--disable-pinentry-emacs",
                "--disable-pinentry-gtk2",
                "--disable-pinentry-qt5",
                "--disable-pinentry-tty",
                "--disable-pinentry-tqt",
                "--disable-pinentry-fltk",
                "--without-libcap",
                "--enable-libsecret=no",
                "--disable-rpath"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://www.gnupg.org/ftp/gcrypt/pinentry/pinentry-1.1.0.tar.bz2",
                    "sha256": "68076686fa724a290ea49cdf0d1c0c1500907d1b759a3bcbfbec0293e8f56570"
                }
            ]
        },
        {
            "name": "pcsc-lite",
            "config-opts": [
                "--disable-libudev",
                "--disable-libsystemd",
                "--without-systemdsystemunitdir",
                "--disable-serial",
                "--disable-usb"
            ],
            "post-install": [
                "rm /app/sbin/pcscd",
                "rmdir /app/sbin || true"
            ],
            "cleanup": [
                "/lib/libpcscspy.so",
                "/lib/libpcsclite.so"
            ],
            "sources": [
        {
                    "type": "archive",
                    "url": "https://github.com/LudovicRousseau/PCSC/archive/pcsc-1.8.25.tar.gz",
                    "sha256": "4dc994bafa88fa348853fba07e787c317c030a986fd0e9f30efc0d160fca6d36"
        }
            ]
        },
        {
            "name": "autoconf-2.13",
            "config-opts": ["--program-suffix=2.13"],
            "cleanup": [ "*" ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://ftp.gnu.org/gnu/autoconf/autoconf-2.13.tar.gz",
                    "sha256": "f0611136bee505811e9ca11ca7ac188ef5323a8e2ef19cffd3edb3cf08fd791e"
                }
            ]
        },
        {
            "name": "yasm",
            "cleanup": [ "*" ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz",
                    "sha256": "3dce6601b495f5b3d45b59f7d2492a340ee7e84b5beca17e48f862502bd5603f"
                }
            ]
        },
        {
            "name": "libnotify",
            "buildsystem": "meson",
            "config-opts": [
                "-Dtests=false",
                "-Dintrospection=disabled",
                "-Dgtk_doc=false",
                "-Ddocbook_docs=disabled"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://download.gnome.org/sources/libnotify/0.7/libnotify-0.7.8.tar.xz",
                    "sha256": "69209e0b663776a00c7b6c0e560302a8dbf66b2551d55616304f240bba66e18c"
                }
            ]
        },
        {
            "name": "cbindgen",
            "buildsystem": "simple",
            "build-commands": [
                "cargo build --release --locked",
                "install -Dm 755 target/release/cbindgen -t /app/bin"
            ],
            "build-options":{
                "append-path": "/usr/lib/sdk/rust-stable/bin",
                "env":{
                    "CARGO_HOME": "/run/build/cbindgen/cargo"
                }
            },
            "cleanup": [ "*" ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/eqrion/cbindgen.git",
                    "tag": "v0.9.1",
                    "commit": "8e4db4c17fbdc0cfa9b98cfe9d47ca6263858def"
                },
                "cbindgen-dependencies.json"
            ]
        },
        {
            "name": "thunderbird",
            "buildsystem": "simple",
            "build-options":{
                "append-path": "/usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node10/bin",
                "append-ld-library-path": "/usr/lib/sdk/node10/lib",
                "env":{
                    "VERSION": "68.3.1",
                    "TERM": "linux",
                    "CARGO_HOME": "/run/build/Thunderbird/cargo",
                    "npm_config_nodedir": "/usr/lib/sdk/node10"
                }
            },
            "build-commands": [
                "install -Dm755 node-stdout-nonblocking-wrapper /app/bin/node",
                "./mach build -v",
                "./mach install",
                "rm -f /app/bin/node",
                "rm -f /app/bin/thunderbird",
                "install -Dm755 thunderbird-wrapper /app/bin/thunderbird",
                "install -Dm644 policies.json /app/lib/thunderbird/distribution/policies.json",
                "install -Dm644 distribution.ini /app/lib/thunderbird/distribution/distribution.ini",
                "for lang in langpacks/*.xpi;do install -Dm644 -t /app/lib/thunderbird/distribution/extensions $lang; done",
                "for i in 16 22 24 32 48 64 128 256;do install -Dm644 comm/mail/branding/thunderbird/default${i}.png /app/share/icons/hicolor/${i}x${i}/apps/thunderbird.png;done",
                "install -Dm644 comm/mail/branding/thunderbird/TB-symbolic.svg /app/share/icons/hicolor/symbolic/apps/thunderbird-symbolic.svg",
                "install -Dm644 org.mozilla.Thunderbird.desktop /app/share/applications/org.mozilla.Thunderbird.desktop",
                "install -Dm644 org.mozilla.Thunderbird.appdata.xml /app/share/metainfo/org.mozilla.Thunderbird.appdata.xml"
            ],
            "sources": [
                "thunderbird-sources.json",
                {
                    "type": "file",
                    "path": "mozconfig"
                },
                {
                    "type": "file",
                    "path": "org.mozilla.Thunderbird.desktop"
                },
                {
                    "type": "file",
                    "path": "org.mozilla.Thunderbird.appdata.xml"
                },
                {
                    "type": "file",
                    "path": "node-stdout-nonblocking-wrapper"
                },
                {
                    "type": "file",
                    "path": "policies.json"
                },
                {
                    "type": "file",
                    "path": "distribution.ini"
                },
                {
                    "type": "file",
                    "path": "thunderbird-wrapper"
                }
            ]
        }
    ]
}
